<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>智能排放驾驶舱</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/modern-css-reset@1.4.0/dist/reset.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --surface: #ffffff;
        --surface-muted: #f8f9fb;
        --surface-strong: #0f172a;
        --surface-border: #d0d7e6;
        --text-primary: #1f2937;
        --text-muted: #6b7280;
        --brand: #2563eb;
        --brand-soft: rgba(37, 99, 235, 0.12);
        --radius-lg: 20px;
        --radius-md: 14px;
        --shadow-soft: 0 24px 48px rgba(15, 23, 42, 0.12);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --surface: #0f172a;
          --surface-muted: #111827;
          --surface-strong: #060b17;
          --surface-border: #1f2937;
          --text-primary: #e5e7eb;
          --text-muted: #94a3b8;
          --brand: #60a5fa;
          --brand-soft: rgba(96, 165, 250, 0.2);
          --shadow-soft: 0 20px 44px rgba(0, 0, 0, 0.55);
        }
      }

      body {
        font-family: "Inter", "Segoe UI", Arial, sans-serif;
        background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 18%, #fff 100%);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background: linear-gradient(180deg, #020617 0%, #0f172a 18%, #111827 100%);
        }
      }

      .page {
        max-width: 1160px;
        margin: 0 auto;
        padding: clamp(24px, 5vw, 56px) clamp(18px, 5vw, 40px);
        display: grid;
        gap: clamp(28px, 4vw, 42px);
      }

      header.hero {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: clamp(32px, 5vw, 48px);
        box-shadow: var(--shadow-soft);
        position: relative;
        overflow: hidden;
      }

      header.hero::before,
      header.hero::after {
        content: "";
        position: absolute;
        border-radius: 999px;
        filter: blur(0.5px);
        opacity: 0.35;
        pointer-events: none;
      }

      header.hero::before {
        width: 320px;
        height: 320px;
        background: radial-gradient(circle, rgba(37, 99, 235, 0.38), transparent);
        top: -140px;
        right: -120px;
      }

      header.hero::after {
        width: 220px;
        height: 220px;
        background: radial-gradient(circle, rgba(79, 70, 229, 0.45), transparent);
        bottom: -120px;
        left: -110px;
      }

      .hero-eyebrow {
        font-size: 0.82rem;
        text-transform: uppercase;
        letter-spacing: 0.24em;
        color: var(--brand);
        font-weight: 600;
      }

      .hero-title {
        margin: 12px 0;
        font-size: clamp(2.2rem, 4vw, 3.2rem);
        line-height: 1.1;
        font-weight: 700;
      }

      .hero-lead {
        max-width: 720px;
        color: var(--text-muted);
        margin-bottom: 18px;
        font-size: clamp(1rem, 1.15vw, 1.18rem);
      }

      .hero-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 999px;
        border: none;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, #2563eb, #7c3aed);
        color: #fff;
        box-shadow: 0 18px 38px rgba(79, 70, 229, 0.28);
      }

      .btn-outline {
        background: transparent;
        border: 1px solid var(--brand);
        color: var(--brand);
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      main.content {
        display: grid;
        gap: clamp(28px, 4vw, 40px);
      }

      section.section-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: clamp(24px, 4vw, 36px);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--surface-border);
      }

      .section-head {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 18px;
      }

      .section-title {
        font-size: clamp(1.4rem, 2.6vw, 1.8rem);
        font-weight: 650;
      }

      .section-desc {
        color: var(--text-muted);
        font-size: 0.98rem;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .summary-card {
        background: var(--surface-muted);
        border-radius: var(--radius-md);
        padding: 18px 20px;
        border: 1px solid rgba(148, 163, 184, 0.26);
        display: grid;
        gap: 4px;
      }

      .summary-label {
        font-size: 0.78rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--brand);
        font-weight: 600;
      }

      .summary-value {
        font-size: 1.62rem;
        font-weight: 700;
      }

      .summary-hint {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      .grid-two {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 18px;
      }

      .data-card {
        background: var(--surface-muted);
        padding: 18px 20px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.26);
        display: grid;
        gap: 12px;
      }

      .card-title {
        font-weight: 600;
        font-size: 1rem;
      }

      table.data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }

      table.data-table thead {
        background: var(--brand-soft);
      }

      table.data-table th,
      table.data-table td {
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      }

      table.data-table tbody tr:nth-child(even) {
        background: rgba(148, 163, 184, 0.12);
      }

      .muted {
        color: var(--text-muted);
      }

      form.predict-form,
      form.train-form {
        display: grid;
        gap: 18px;
      }

      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 14px;
      }

      .feature-grid label {
        display: grid;
        gap: 6px;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      input,
      select,
      textarea {
        font-family: inherit;
        font-size: 1rem;
      }

      .field-input,
      textarea {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.32);
        background: #fff;
        color: inherit;
      }

      textarea {
        resize: vertical;
        min-height: 140px;
        font-family: "Fira Code", "Consolas", monospace;
      }

      .field-input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.16);
      }

      .control-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .control-row select {
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.32);
        background: #fff;
        color: inherit;
      }

      .control-row label {
        font-size: 0.92rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .result {
        background: var(--surface-muted);
        padding: 16px 18px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.22);
      }

      .train-switch {
        display: inline-flex;
        gap: 10px;
        padding: 6px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.2);
      }

      .train-switch button {
        border: none;
        background: transparent;
        padding: 8px 18px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-muted);
      }

      .train-switch button.active {
        background: rgba(37, 99, 235, 0.18);
        color: var(--brand);
      }

      .toast {
        position: fixed;
        right: 24px;
        bottom: 24px;
        background: rgba(37, 99, 235, 0.94);
        color: #fff;
        padding: 12px 16px;
        border-radius: 12px;
        transform: translateY(16px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        box-shadow: var(--shadow-soft);
        z-index: 20;
      }

      .toast.visible {
        opacity: 1;
        transform: translateY(0);
      }

      footer {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.84rem;
        padding-bottom: 24px;
      }

      @media (max-width: 720px) {
        header.hero {
          padding: 28px 24px;
        }

        .control-row {
          flex-direction: column;
          align-items: stretch;
        }

        .control-row select,
        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <span class="hero-eyebrow">Emission Intelligence</span>
        <h1 class="hero-title">智能排放预测驾驶舱</h1>
        <p class="hero-lead">
          聚合数据质量、模型表现与在线预测，帮助团队快速洞察排放走势并
          在风险出现前启动优化。
        </p>
        <div class="hero-actions">
          <button class="btn btn-primary" id="scroll-to-predict">立即预测</button>
          <button class="btn btn-outline" id="scroll-to-train">更新训练数据</button>
        </div>
      </header>

      <main class="content">
        <section class="section-card" id="summary-section">
          <div class="section-head">
            <h2 class="section-title">运行概览</h2>
            <p class="section-desc">
              快速浏览核心指标，评估数据规模、质量与当前最优策略表现。
            </p>
          </div>
          <div class="summary-grid" id="summary-cards">
            <article class="summary-card">
              <span class="summary-label">加载中</span>
              <span class="summary-value">···</span>
              <span class="summary-hint">等待后端同步</span>
            </article>
          </div>
          <p class="muted" id="summary-updated">最后更新：初始化中…</p>
        </section>

        <section class="section-card" id="data-section">
          <div class="section-head">
            <h2 class="section-title">数据洞察</h2>
            <p class="section-desc">
              了解字段缺失、保留特征与自动融合权重，确保建模基础可信。
            </p>
          </div>
          <div class="grid-two">
            <div class="data-card" id="dataset-missing">
              <p class="muted">字段缺失率加载中…</p>
            </div>
            <div class="data-card" id="dataset-features">
              <p class="muted">特征概览加载中…</p>
            </div>
          </div>
          <div class="grid-two" style="margin-top: 18px;">
            <div class="data-card" id="weights-ensemble">
              <p class="muted">组合策略权重加载中…</p>
            </div>
            <div class="data-card" id="weights-stacking">
              <p class="muted">Stacking 贡献加载中…</p>
            </div>
          </div>
          <div class="data-card" style="margin-top: 18px;" id="dataset-retained">
            <p class="muted">保留特征加载中…</p>
          </div>
        </section>

        <section class="section-card" id="metrics-section">
          <div class="section-head">
            <h2 class="section-title">模型表现</h2>
            <p class="section-desc">
              对比基础模型与组合策略的 R²、MAPE、MAE 与 RMSE 指标。
            </p>
          </div>
          <div class="data-card" id="metrics-table">
            <p class="muted">指标加载中…</p>
          </div>
        </section>

        <section class="section-card" id="insight-section">
          <div class="section-head">
            <h2 class="section-title">特征影响</h2>
            <p class="section-desc">
              基于置换重要性与 SHAP 分析，识别驱动排放变化的关键因子。
            </p>
          </div>
          <div class="grid-two">
            <div class="data-card" id="permutation-importance">
              <p class="muted">置换重要性加载中…</p>
            </div>
            <div class="data-card" id="shap-importance">
              <p class="muted">SHAP 分析加载中…</p>
            </div>
          </div>
        </section>

        <section class="section-card" id="optimization-section">
          <div class="section-head">
            <h2 class="section-title">优化实验</h2>
            <p class="section-desc">
              汇总粒子群、贝叶斯与遗传算法的最优结果，评估参数调优效率。
            </p>
          </div>
          <div class="grid-two">
            <div class="data-card" id="optimization-experiments">
              <p class="muted">优化实验记录加载中…</p>
            </div>
            <div class="data-card" id="optimization-summary">
              <p class="muted">历史对比加载中…</p>
            </div>
          </div>
        </section>

        <section class="section-card" id="monitor-section">
          <div class="section-head">
            <h2 class="section-title">运行监控</h2>
            <p class="section-desc">
              查看阈值监控样例及触发的优化动作，评估自适应响应能力。
            </p>
          </div>
          <div class="data-card" id="monitor-log">
            <p class="muted">监控日志加载中…</p>
          </div>
        </section>

        <section class="section-card" id="prediction-panel">
          <div class="section-head">
            <h2 class="section-title">在线预测</h2>
            <p class="section-desc">
              输入关键特征即可查看不同策略下的预测结果与置信区间。
            </p>
          </div>
          <form id="predict-form" class="predict-form">
            <div class="feature-grid" id="feature-inputs"></div>
            <div class="control-row">
              <label>
                策略
                <select id="strategy-select"></select>
              </label>
              <label>
                <input type="checkbox" id="uncertainty-toggle" /> 展示预测区间
              </label>
              <button class="btn btn-primary" type="submit">生成预测</button>
            </div>
          </form>
          <div class="result" id="prediction-result"></div>
          <div class="result" id="prediction-table"></div>
          <div class="result" id="uncertainty-result"></div>
        </section>

        <section class="section-card" id="train-panel">
          <div class="section-head">
            <h2 class="section-title">快速重训</h2>
            <p class="section-desc">
              支持指定数据集路径或粘贴实时记录，触发后端重新训练模型。
            </p>
          </div>
          <div class="train-switch" role="tablist">
            <button
              type="button"
              class="active"
              data-train-mode="path"
              aria-selected="true"
            >
              使用数据集路径
            </button>
            <button type="button" data-train-mode="json" aria-selected="false">
              粘贴实时记录
            </button>
          </div>
          <form id="train-form" class="train-form">
            <div id="dataset-path-field">
              <label>
                数据集文件路径
                <input
                  type="text"
                  id="dataset-path-input"
                  class="field-input"
                  placeholder="例如 /data/emission_demo.csv"
                />
              </label>
              <label>
                （可选）数据库表名
                <input
                  type="text"
                  id="dataset-table-input"
                  class="field-input"
                  placeholder="如使用 SQLite，可填写表名"
                />
              </label>
            </div>
            <div id="record-json-field" style="display: none;">
              <label>
                记录数组（JSON）
                <textarea
                  id="record-json-input"
                  placeholder='[{"emission": 520, "temperature": 320, ...}]'
                ></textarea>
              </label>
            </div>
            <div class="control-row">
              <button class="btn btn-outline" type="button" id="train-fill-sample">
                填充示例
              </button>
              <button class="btn btn-primary" type="submit">提交重训</button>
            </div>
            <p class="muted" id="train-status">等待输入数据…</p>
          </form>
        </section>
      </main>

      <footer>由集成学习驱动的排放预测示例 · Flask + XGBoost</footer>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const state = {
        features: [],
        strategies: [],
        weights: {},
        stackingWeights: {},
        lastUpdated: null,
        trainMode: "path",
      };

      const strategyDisplayNames = {
        mean: "均值融合",
        equal: "等权融合",
        residual: "残差自适应",
        self_adaption: "自适应加权",
        stacking: "Stacking",
        rf: "随机森林",
        xgb: "XGBoost",
        mlp: "多层感知机",
        gbr: "梯度提升树",
        hgb: "直方图梯度提升",
        pso: "粒子群优化",
        bayesian: "贝叶斯优化",
        bayes: "贝叶斯优化",
        ga: "遗传算法",
      };

      function sanitizeId(value) {
        return value.replace(/[^a-zA-Z0-9-_]/g, "-");
      }

      function createTable(headers, rows) {
        if (!rows.length) {
          return '<p class="muted">暂无数据</p>';
        }
        const thead = `<thead><tr>${headers
          .map((header) => `<th>${header}</th>`)
          .join("")}</tr></thead>`;
        const tbody = `<tbody>${rows
          .map((row) => `<tr>${row.map((cell) => `<td>${cell}</td>`).join("")}</tr>`)
          .join("")}</tbody>`;
        return `<table class="data-table">${thead}${tbody}</table>`;
      }

      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.style.background =
          type === "success"
            ? "rgba(16, 185, 129, 0.94)"
            : type === "error"
            ? "rgba(239, 68, 68, 0.94)"
            : "rgba(37, 99, 235, 0.94)";
        toast.classList.add("visible");
        setTimeout(() => toast.classList.remove("visible"), 3200);
      }

      async function fetchJSON(url, options) {
        const response = await fetch(url, options);
        if (!response.ok) {
          const text = await response.text();
          throw new Error(`请求失败: ${response.status} ${text}`);
        }
        return response.json();
      }

      function renderSummary(report, metrics) {
        if (!report) {
          return;
        }
        const retained = report.retained_features || [];
        const sampleCount = report.n_rows ?? 0;
        const engineered = Math.max(retained.length - (state.features?.length || 0), 0);
        const missingValues = Object.values(report.missing_rate || {});
        const avgMissing =
          missingValues.length > 0
            ? missingValues.reduce((acc, value) => acc + Number(value || 0), 0) /
              missingValues.length
            : 0;
        const qualityScore = Math.max(0, 100 - avgMissing * 100);
        const bestEntry = (() => {
          if (!metrics) {
            return { label: "-", value: "-" };
          }
          const entries = [
            ...Object.entries(metrics.base_models || {}),
            ...Object.entries(metrics.ensembles || {}),
          ];
          if (!entries.length) {
            return { label: "-", value: "-" };
          }
          const [name, data] = entries.sort(([, a], [, b]) => b.r2 - a.r2)[0];
          return {
            label: name,
            value: `${Number(data.r2 || 0).toFixed(3)} R²`,
          };
        })();
        const stats = [
          {
            label: "清洗后样本",
            value: new Intl.NumberFormat("zh-CN").format(Math.round(sampleCount)),
            hint: "用于训练与验证的记录数",
          },
          {
            label: "建模特征",
            value: new Intl.NumberFormat("zh-CN").format(retained.length),
            hint: engineered > 0 ? `含派生特征 ${engineered} 项` : "以业务关键字段为主",
          },
          {
            label: "数据稳定度",
            value: `${qualityScore.toFixed(1)}%`,
            hint:
              (report.high_correlation_pairs || []).length > 0
                ? `高相关特征对 ${(report.high_correlation_pairs || []).length} 组`
                : "已自动消除高共线性干扰",
          },
          {
            label: "最佳模型",
            value: bestEntry.value,
            hint: `当前策略：${strategyDisplayNames[bestEntry.label] || bestEntry.label}`,
          },
        ];
        const container = document.getElementById("summary-cards");
        container.innerHTML = stats
          .map(
            (item) => `
              <article class="summary-card">
                <span class="summary-label">${item.label}</span>
                <span class="summary-value">${item.value}</span>
                <span class="summary-hint">${item.hint}</span>
              </article>
            `,
          )
          .join("");
        state.lastUpdated = new Date();
        document.getElementById("summary-updated").textContent =
          `最后更新：${state.lastUpdated.toLocaleString("zh-CN")}`;
      }

      function renderDataQuality(report) {
        if (!report) {
          return;
        }
        const missingContainer = document.getElementById("dataset-missing");
        const missingRows = Object.entries(report.missing_rate || {})
          .sort(([, a], [, b]) => Number(b) - Number(a))
          .map(([feature, value]) => [feature, `${(Number(value) * 100).toFixed(2)}%`])
          .slice(0, 12);
        missingContainer.innerHTML = `
          <p class="card-title">字段缺失率（Top12）</p>
          ${createTable(["特征", "缺失率"], missingRows)}
        `;

        const featureContainer = document.getElementById("dataset-features");
        const featureRows = Object.entries(report.feature_summary || {})
          .map(([feature, info]) => [
            feature,
            `${Number(info.mean ?? 0).toFixed(2)} ± ${Number(info.std ?? 0).toFixed(2)}`,
            `${Number(info.min ?? 0).toFixed(2)} ~ ${Number(info.max ?? 0).toFixed(2)}`,
          ])
          .slice(0, 12);
        featureContainer.innerHTML = `
          <p class="card-title">特征统计（Top12）</p>
          ${createTable(["特征", "均值±方差", "范围"], featureRows)}
        `;

        const retainedContainer = document.getElementById("dataset-retained");
        const retained = report.retained_features || [];
        retainedContainer.innerHTML = retained.length
          ? `
              <p class="card-title">保留特征 (${retained.length})</p>
              <p class="muted">涵盖模型最终使用的字段，按字母序展示。</p>
              <ul class="muted" style="display: grid; gap: 6px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
                ${retained
                  .sort()
                  .map((feature) => `<li>${feature}</li>`)
                  .join("")}
              </ul>
            `
          : '<p class="muted">未找到保留特征信息。</p>';
      }

      function renderWeights(weights, stackingWeights) {
        const ensembleContainer = document.getElementById("weights-ensemble");
        if (!weights || !Object.keys(weights).length) {
          ensembleContainer.innerHTML = '<p class="muted">暂无组合策略权重。</p>';
        } else {
          const rows = Object.entries(weights).map(([name, value]) => [
            strategyDisplayNames[name] || name,
            `XGBoost ${(Number(value.xgb) * 100).toFixed(1)}% · RF ${(Number(
              value.rf,
            ) * 100).toFixed(1)}%`,
          ]);
          ensembleContainer.innerHTML = `
            <p class="card-title">组合策略权重</p>
            ${createTable(["策略", "权重"], rows)}
          `;
        }

        const stackingContainer = document.getElementById("weights-stacking");
        if (!stackingWeights || !Object.keys(stackingWeights).length) {
          stackingContainer.innerHTML = '<p class="muted">暂无 Stacking 权重数据。</p>';
        } else {
          const rows = Object.entries(stackingWeights)
            .sort(([, a], [, b]) => b - a)
            .map(([name, value]) => [
              strategyDisplayNames[name] || name,
              `${(Number(value) * 100).toFixed(1)}%`,
            ]);
          stackingContainer.innerHTML = `
            <p class="card-title">Stacking 贡献</p>
            ${createTable(["模型", "贡献度"], rows)}
          `;
        }
      }

      function renderMetrics(metrics) {
        const container = document.getElementById("metrics-table");
        if (!metrics) {
          container.innerHTML = '<p class="muted">暂无指标。</p>';
          return;
        }
        const rows = [];
        Object.entries(metrics.base_models || {}).forEach(([name, values]) => {
          rows.push([
            `基础-${strategyDisplayNames[name] || name}`,
            Number(values.r2).toFixed(3),
            `${(Number(values.mape) * 100).toFixed(2)}%`,
            Number(values.mae).toFixed(3),
            Number(values.rmse).toFixed(3),
          ]);
        });
        Object.entries(metrics.ensembles || {}).forEach(([name, values]) => {
          rows.push([
            `组合-${strategyDisplayNames[name] || name}`,
            Number(values.r2).toFixed(3),
            `${(Number(values.mape) * 100).toFixed(2)}%`,
            Number(values.mae).toFixed(3),
            Number(values.rmse).toFixed(3),
          ]);
        });
        container.innerHTML = `
          <p class="card-title">核心指标</p>
          ${createTable(["模型", "R²", "MAPE", "MAE", "RMSE"], rows)}
        `;
      }

      function renderPermutation(data) {
        const container = document.getElementById("permutation-importance");
        if (!data || !data.length) {
          container.innerHTML = '<p class="muted">暂未生成置换重要性。</p>';
          return;
        }
        const rows = data.map((item) => [
          item.feature,
          Number(item.importance).toFixed(4),
        ]);
        container.innerHTML = `
          <p class="card-title">置换重要性（随机森林）</p>
          ${createTable(["特征", "重要性"], rows)}
        `;
      }

      function renderShap(shap) {
        const container = document.getElementById("shap-importance");
        if (!shap) {
          container.innerHTML = '<p class="muted">SHAP 分析不可用。</p>';
          return;
        }
        const sections = Object.entries(shap)
          .map(([name, values]) => {
            const rows = values.map((item) => [
              item.feature,
              Number(item.importance).toFixed(4),
            ]);
            const label = strategyDisplayNames[name] || name.toUpperCase();
            return `
              <div class="data-card" style="padding: 16px;">
                <p class="card-title">${label} 平均 |SHAP|</p>
                ${createTable(["特征", "影响力"], rows)}
              </div>
            `;
          })
          .join("");
        container.innerHTML = sections || '<p class="muted">暂无 SHAP 数据。</p>';
      }

      function renderOptimization(data) {
        const experimentsContainer = document.getElementById(
          "optimization-experiments",
        );
        const summaryContainer = document.getElementById(
          "optimization-summary",
        );

        const experiments = data?.experiments ?? [];
        if (!experiments.length) {
          experimentsContainer.innerHTML =
            '<p class="muted">暂无优化实验记录。</p>';
        } else {
          const rows = experiments.map((item) => [
            strategyDisplayNames[item.algorithm] || item.algorithm,
            Array.isArray(item.best_params)
              ? item.best_params.map((value) => Number(value).toFixed(2)).join(", ")
              : item.best_params,
            Number(item.best_val).toFixed(4),
          ]);
          experimentsContainer.innerHTML = `
            <p class="card-title">最新实验结果</p>
            ${createTable(["算法", "最优参数", "目标值"], rows)}
          `;
        }

        const summary = data?.summary ?? [];
        if (!summary.length) {
          summaryContainer.innerHTML =
            '<p class="muted">暂无历史对比数据。</p>';
        } else {
          const rows = summary.map((item) => [
            strategyDisplayNames[item.algorithm] || item.algorithm,
            item.best_params,
            Number(item.best_val ?? item.value ?? item.score ?? 0).toFixed(4),
            item.iterations ?? "-",
          ]);
          summaryContainer.innerHTML = `
            <p class="card-title">历史表现对比</p>
            ${createTable(["算法", "最优参数", "最佳值", "迭代数"], rows)}
          `;
        }
      }

      function renderMonitor(data) {
        const container = document.getElementById("monitor-log");
        const log = data?.log ?? [];
        if (!log.length) {
          container.innerHTML = '<p class="muted">暂无监控记录。</p>';
          return;
        }
        const rows = log.map((item) => [
          (item.step ?? 0) + 1,
          item.actual != null ? Number(item.actual).toFixed(2) : "-",
          item.predicted != null ? Number(item.predicted).toFixed(2) : "-",
          Array.isArray(item.action)
            ? item.action.map((value) => Number(value).toFixed(2)).join(", ")
            : "-",
          Number(item.value ?? 0).toFixed(3),
          item.forced ? "是" : "否",
        ]);
        container.innerHTML = `
          <p class="card-title">阈值监控样例 (阈值 ${Number(
            data?.threshold ?? 0
          ).toFixed(2)})</p>
          ${createTable([
            "步次",
            "实际排放",
            "预测排放",
            "优化动作",
            "目标值",
            "人工触发",
          ], rows)}
        `;
      }

      function renderFeatureInputs(features, strategies) {
        const container = document.getElementById("feature-inputs");
        container.innerHTML = "";
        if (!features.length) {
          container.innerHTML = '<p class="muted">未从后端获取到特征列表。</p>';
        }
        features.forEach((feature) => {
          const label = document.createElement("label");
          label.textContent = feature;
          const input = document.createElement("input");
          input.type = "number";
          input.step = "any";
          input.id = `feature-${sanitizeId(feature)}`;
          input.required = true;
          input.placeholder = "请输入数值";
          input.dataset.feature = feature;
          input.classList.add("field-input");
          label.appendChild(input);
          container.appendChild(label);
        });
        const select = document.getElementById("strategy-select");
        select.innerHTML = "";
        strategies.forEach((strategy) => {
          const option = document.createElement("option");
          option.value = strategy;
          option.textContent = strategyDisplayNames[strategy] || strategy;
          select.appendChild(option);
        });
      }

      async function initDashboard() {
        try {
          const [metadata, metrics, insights, optimization, monitor] =
            await Promise.all([
              fetchJSON("/metadata"),
              fetchJSON("/metrics"),
              fetchJSON("/feature-insights"),
              fetchJSON("/optimization"),
              fetchJSON("/monitor-sample"),
            ]);
          state.features = metadata.features || [];
          state.strategies = metadata.strategies || [];
          state.weights = metadata.ensemble_weights || {};
          state.stackingWeights = metadata.stacking_weights || {};
          renderFeatureInputs(state.features, state.strategies);
          renderDataQuality(metadata.report);
          renderWeights(state.weights, state.stackingWeights);

          renderSummary(metadata.report, metrics);
          renderMetrics(metrics);

          renderPermutation(insights.permutation_importance);
          renderShap(insights.shap_summary);

          renderOptimization(optimization);
          renderMonitor(monitor);

          const metrics = await fetchJSON("/metrics");
          renderSummary(metadata.report, metrics);
          renderMetrics(metrics);

          const insights = await fetchJSON("/feature-insights");
          renderPermutation(insights.permutation_importance);
          renderShap(insights.shap_summary);

          showToast("仪表盘数据已更新", "success");
        } catch (error) {
          document.getElementById("prediction-result").innerHTML =
            `<p class="muted">初始化失败：${error.message}</p>`;
          showToast(`初始化失败：${error.message}`, "error");
        }
      }

      async function handlePredict(event) {
        event.preventDefault();
        const inputs = Array.from(document.querySelectorAll("#feature-inputs input"));
        const payload = {};
        for (const input of inputs) {
          const value = input.value;
          if (value === "") {
            input.focus();
            showToast("请输入完整特征值后再预测", "error");
            return;
          }
          payload[input.dataset.feature] = Number(value);
        }
        const strategy = document.getElementById("strategy-select").value;
        const includeUncertainty = document.getElementById("uncertainty-toggle").checked;
        try {
          const data = await fetchJSON(
            `/predict?strategy=${encodeURIComponent(strategy)}&all_strategies=true&uncertainty=${includeUncertainty}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            },
          );
          const tableContainer = document.getElementById("prediction-table");
          const resultContainer = document.getElementById("prediction-result");
          const uncertaintyContainer = document.getElementById("uncertainty-result");
          tableContainer.innerHTML = "";
          resultContainer.innerHTML = "";
          uncertaintyContainer.innerHTML = "";

          if (data.predictions) {
            const rows = Object.entries(data.predictions).map(([name, values]) => [
              strategyDisplayNames[name] || name,
              values.map((value) => Number(value).toFixed(2)).join(", "),
            ]);
            tableContainer.innerHTML = createTable(["策略", "预测值"], rows);
            resultContainer.innerHTML =
              '<p class="muted">预测完成，已展示各策略输出。</p>';
            if (data.uncertainty) {
              const lower = data.uncertainty.lower.map((value) => Number(value).toFixed(2));
              const upper = data.uncertainty.upper.map((value) => Number(value).toFixed(2));
              const center = data.uncertainty.prediction.map((value) => Number(value).toFixed(2));
              uncertaintyContainer.innerHTML = `
                <p><strong>区间 (${strategyDisplayNames[data.uncertainty.strategy] || data.uncertainty.strategy})</strong></p>
                <p class="muted">${center
                  .map((value, idx) => `${value} [${lower[idx]}, ${upper[idx]}]`)
                  .join("， ")}</p>
              `;
            }
          } else if (data.prediction) {
            resultContainer.innerHTML = `
              <p>预测结果（${strategyDisplayNames[data.strategy] || data.strategy}）：${data.prediction
                .map((value) => Number(value).toFixed(2))
                .join(", ")}</p>
            `;
            if (data.lower && data.upper) {
              const intervalText = data.lower
                .map((value, idx) =>
                  `${Number(data.prediction[idx]).toFixed(2)} [${Number(value).toFixed(2)}, ${Number(
                    data.upper[idx],
                  ).toFixed(2)}]`,
                )
                .join("， ");
              uncertaintyContainer.innerHTML = `<p class="muted">预测区间：${intervalText}</p>`;
            }
          } else {
            resultContainer.innerHTML = '<p class="muted">未收到预测结果。</p>';
          }
          showToast("预测完成", "success");
        } catch (error) {
          document.getElementById("prediction-result").innerHTML =
            `<p class="muted">预测失败：${error.message}</p>`;
          showToast(`预测失败：${error.message}`, "error");
        }
      }

      function handleTrainModeChange(mode) {
        state.trainMode = mode;
        document
          .querySelectorAll('.train-switch button')
          .forEach((button) => button.classList.toggle('active', button.dataset.trainMode === mode));
        document
          .getElementById('dataset-path-field')
          .style.display = mode === 'path' ? 'block' : 'none';
        document
          .getElementById('record-json-field')
          .style.display = mode === 'json' ? 'block' : 'none';
        document.getElementById('train-status').textContent = '等待输入数据…';
      }

      function buildTrainPayload() {
        if (state.trainMode === 'path') {
          const path = document.getElementById('dataset-path-input').value.trim();
          const table = document.getElementById('dataset-table-input').value.trim();
          if (!path) {
            throw new Error('请提供数据集路径');
          }
          const payload = { dataset_path: path };
          if (table) {
            payload.dataset_table = table;
          }
          return payload;
        }
        const raw = document.getElementById('record-json-input').value.trim();
        if (!raw) {
          throw new Error('请粘贴至少一条 JSON 记录');
        }
        try {
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed) || !parsed.length) {
            throw new Error('JSON 必须为包含记录的数组');
          }
          return { records: parsed };
        } catch (error) {
          throw new Error(`JSON 解析失败：${error.message}`);
        }
      }

      function fillTrainSample() {
        if (state.trainMode === 'path') {
          document.getElementById('dataset-path-input').value = '/data/emission_demo.csv';
          document.getElementById('dataset-table-input').value = '';
        } else {
          const sample = [
            {
              emission: 520,
              temperature: 320,
              pressure: 2.4,
              humidity: 42,
              flow_rate: 860,
            },
            {
              emission: 498,
              temperature: 318,
              pressure: 2.2,
              humidity: 45,
              flow_rate: 845,
            },
          ];
          document.getElementById('record-json-input').value = JSON.stringify(sample, null, 2);
        }
        document.getElementById('train-status').textContent = '已填充示例，可直接提交';
      }

      async function handleTrain(event) {
        event.preventDefault();
        const status = document.getElementById('train-status');
        try {
          const payload = buildTrainPayload();
          status.textContent = '正在提交重训任务…';
          const result = await fetchJSON('/train', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          status.textContent = `训练完成，样本数 ${result.rows}`;
          showToast('训练完成，正在刷新仪表盘', 'success');
          await initDashboard();
        } catch (error) {
          status.textContent = `训练失败：${error.message}`;
          showToast(`训练失败：${error.message}`, 'error');
        }
      }

      document.getElementById('predict-form').addEventListener('submit', handlePredict);
      document.getElementById('train-form').addEventListener('submit', handleTrain);
      document.getElementById('train-fill-sample').addEventListener('click', fillTrainSample);
      document
        .querySelectorAll('.train-switch button')
        .forEach((button) =>
          button.addEventListener('click', () => handleTrainModeChange(button.dataset.trainMode)),
        );

      document.getElementById('scroll-to-predict').addEventListener('click', () => {
        document.getElementById('prediction-panel').scrollIntoView({
          behavior: 'smooth',
          block: 'start',
        });
      });
      document.getElementById('scroll-to-train').addEventListener('click', () => {
        document.getElementById('train-panel').scrollIntoView({
          behavior: 'smooth',
          block: 'start',
        });
      });

      document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
  </body>
</html>
